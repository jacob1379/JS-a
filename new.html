<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css" />

    <style>
        .safe {
            color: green;
        }

        .common {
            color: orange;
        }

        .warn {
            color: red;
        }
    </style>

    <script>
        const init = (cities) => {
            const $buttons = $('#buttons')
            cities.forEach((city, index) => {
                $('<button>').text(city.name).attr('data-cno', index).appendTo($buttons);
            })
        }

        const getPosition = async (cities, key, cno, positionUrl) => {
            const params = { q: cities[cno].code, appid: key };
            const result = await $.ajax({ url: positionUrl, data: params })
            return { lat: result[0].lat, lon: result[0].lon };
        }

        const getWeather = async (key, weatherUrl, position) => {
            const params = { lat: position.lat, lon: position.lon, appid: key, units: 'metric' };
            const result = await $.ajax({ url: weatherUrl, data: params })
            return {
                temp: result.current.temp,
                uvi: result.current.uvi,
                weather: result.current.weather[0].main
            }
        }

        const getAir = async (key, airUrl, position) => {
            const params = { lat: position.lat, lon: position.lon, appid: key };
            const result = await $.ajax({ url: airUrl, data: params });
            console.log(result)
            return { pm10: result.list[0].components.pm10 }
        }
        const getPrint = (cities, cno, position, weather, air) => {
            const $list = $('#weather')
            $('<div>').text(`${cities[cno].name} (위도: ${position.lat}, 경도: ${position.lon})`).appendTo($list);

            let icon = undefined;

            if (weather.weather === 'Rain') {
                icon = `<i class='fas fa-cloud-showers-heavy'></i>`
            } else if (weather.weather === 'Sun') {
                icon = `<i class='fas fa-sun'></i>`
            } else { icon = `<i class='fas fa-cloud-sun'></i>` };
            $('<div>').html(icon).appendTo($list);

            $('<div>').text(`온도 : ${weather.temp}`).appendTo($list);
            if (weather.uvi > 3) {
                $('<div>').text(`자외선 : ${weather.uvi}`).attr('color', 'safe').appendTo($list);
            } else if (weather.uve > 9) {
                $('<div>').text(`자외선 : ${weather.uvi}`).attr('color', 'common').appendTo($list);
            } else {
                $('<div>').text(`자외선 : ${weather.uvi}`).attr('color', 'warn').appendTo($list);
            }
            $('<div>').text(`미세먼지 : ${air.pm10}`).appendTo($list);

        }

        $(document).ready(async function () {
            const cities = [{ name: '인천', code: 'Incheon' }, { name: '도쿄', code: 'Tokyo' }, { name: '서울', code: 'Seoul' }];
            let cno = 0;
            const key = "f0b9abc4dd65ee7c4c88caeb205925c0";
            const positionUrl = `https://api.openweathermap.org/geo/1.0/direct`;
            const airUrl = `https://api.openweathermap.org/data/2.5/air_pollution`;
            const weatherUrl = `https://api.openweathermap.org/data/2.5/onecall`;

            init(cities);
            let position = await getPosition(cities, key, cno, positionUrl);
            let weather = await getWeather(key, weatherUrl, position);
            let air = await getAir(key, airUrl, position);

            getPrint(cities, cno, position, weather, air)


            $('#buttons').click(async function () {

            })
        })

    </script>
</head>

<body>
    <div id="app">
        <div id="weather"></div>
        <div id="buttons"></div>
    </div>
</body>

</html>